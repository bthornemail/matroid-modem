# RFC-0007

# Ledger Replay Equivalence Tests v1.0

## Deterministic Reproducibility Verification

Status: Draft
Depends on: RFC-0001â€“0006

---

# 1. Purpose

Defines test suite ensuring replay determinism.

---

# 2. Replay Model

Given:

* basisHash
* closure_registry.json
* NDJSON ledger prefix

Replay pipeline:

```
MÂ²(events)
 â†’ ğ“œ (matroid filter)
 â†’ C (canvas projection)
 â†’ SAB matrix
```

---

# 3. Equivalence Requirements

Two replays are equivalent iff:

### 3.1 Ledger Hash

Final commit self_hash identical.

### 3.2 Independent Set Hash

Sorted list of independent self_hash values identical.

### 3.3 SAB Matrix

Byte-for-byte identical matrix.

### 3.4 Canvas Export

Canonical JSON serialization identical.

---

# 4. Golden Test Vector Format

```json
{
  "basisHash": "...",
  "registry_hash": "...",
  "ledger": "events.ndjson",
  "expected": {
    "independent_hashes": ["h1","h2"],
    "sab_hash": "sha256-...",
    "canvas_hash": "sha256-..."
  }
}
```

---

# 5. Negative Tests

System MUST fail equivalence when:

* basis mismatch
* registry change
* event order modified
* drift threshold altered

---

# 6. Replay CLI Requirement

CLI command:

```
portal replay events.ndjson --basis founding-v1
```

Outputs:

```
âœ“ Ledger hash match
âœ“ Independent set match
âœ“ SAB projection match
âœ“ Canvas match
```

---

# 7. Determinism Constraints

Replay MUST:

* Sort by canonical ordering
* Canonicalize JSON
* Exclude non-deterministic timestamps
* Exclude random seeds

---

# 8. CI Integration

All releases MUST pass:

* Golden vector tests
* Circuit detection tests
* SAB geometry tests

---

# 9. Core Invariant

> If replay changes under identical inputs, the build is invalid.
