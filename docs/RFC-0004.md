# RFC-0004

# ESP32 Serial Device Profile v1.0

## NDJSON-Native Semantic Sensor Device

Status: Draft
Implements: Portal v1.0

---

# 1. Purpose

Defines how ESP32 devices communicate with the Portal over Web Serial.

Devices are:

* Stateless
* NDJSON emitters
* Basis-agnostic

---

# 2. Transport

* USB CDC (Serial)
* 115200 baud default
* UTF-8 text
* One JSON per line

---

# 3. Mandatory Records

## 3.1 device_hello

```json
{
  "type": "device_hello",
  "deviceId": "esp32-01",
  "firmware": "lattice-v1",
  "capabilities": ["gpio","lux","temperature"],
  "t": 1710000000
}
```

---

## 3.2 probe_gpio

```json
{
  "type": "probe_gpio",
  "deviceId": "esp32-01",
  "pin": 14,
  "value": 1,
  "t": 1710000010
}
```

---

## 3.3 probe_sensor

```json
{
  "type": "probe_sensor",
  "deviceId": "esp32-01",
  "sensor": "lux",
  "value": 312,
  "unit": "lux",
  "t": 1710000020
}
```

---

# 4. Optional Records

## 4.1 render_ack

```json
{
  "type": "render_ack",
  "deviceId": "panel-01",
  "column": 2,
  "quadrant": "KK",
  "t": 1710000030
}
```

---

# 5. Device Rules

Devices MUST:

* Never interpret semantic meaning
* Never validate basisHash
* Never resolve closures
* Only emit physical evidence

Portal decides meaning.

---

# 6. Serial Framing Rules

* Max line length: 4KB
* No binary frames
* Invalid JSON lines ignored
* Basis mismatch handled by browser

---

# 7. Security

Devices may optionally include:

```
device_signature
```

Portal may verify firmware hash.

---

# 8. Deterministic Rendering Bridge

When portal resolves:

```
synset_reply
```

Portal may emit:

```
render_instruction
```

Device must treat this as:

```
render only
```

No semantic interpretation.

---

# 9. Firmware Minimal Loop

Pseudo-logic:

```
loop:
  read sensors
  if change:
    emit NDJSON probe
  if serial input render_instruction:
    update LEDs
```

---

# 10. Invariant

> ESP32 devices are semantic-blind.
> The browser is semantic authority.
